name: Deploy to AKS on Push to Dev

on:
  push:
    branches:
      - dev  

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout kubernetes-manifests directory
      run: |
        # Create a directory to hold the manifests
        mkdir kubernetes-manifests
        cd kubernetes-manifests
        git init
        git remote add origin https://github.com/Shaheer4636/google-microservices-poc.git
        git config core.sparseCheckout true
        echo "microservices-demo-main/kubernetes-manifests/*" >> .git/info/sparse-checkout
        git pull origin dev  # Clone the manifests from the dev branch

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}  # Use your Azure service principal secret

    - name: Set up AKS context
      uses: azure/aks-set-context@v2
      with:
        resource-group: 'microservices-demo-rg'  # Replace with your resource group name
        cluster-name: 'microservices-demo-aks'  # Replace with your AKS cluster name

    - name: Apply Kubernetes Manifests
      run: |
        cd kubernetes-manifests  # Navigate to the kubernetes-manifests directory
        kubectl apply -f .  